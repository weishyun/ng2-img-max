!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("rxjs"),require("exif-js/exif"),require("ng2-pica")):"function"==typeof define&&define.amd?define(["exports","@angular/core","rxjs","exif-js/exif","ng2-pica"],t):t(e["ng2-img-max"]=e["ng2-img-max"]||{},e.ng.core,e.Rx,null,e.ng2Pica)}(this,function(e,t,p,i,r){"use strict";var n=function(){function e(){}return e.prototype.getOrientedImage=function(g){return new Promise(function(c,e){var u;EXIF||(EXIF={getData:function(e,t){return t.call(g),!0},getTag:function(){return!1}}),EXIF.getData(g,function(){var e=EXIF.getTag(g,"Orientation");if(1!=e){var t=document.createElement("canvas"),i=t.getContext("2d"),r=g.width,n=g.height,o=0,a=0,s=0;switch(e){case 3:case 4:o=-g.width,a=-g.height,s=180;break;case 5:case 6:r=g.height,n=g.width,a=-g.height,s=90;break;case 7:case 8:r=g.height,n=g.width,o=-g.width,s=270}t.width=r,t.height=n,-1<[2,4,5,7].indexOf(e)&&(i.translate(r,0),i.scale(-1,1)),i.rotate(s*Math.PI/180),i.drawImage(g,o,a),(u=document.createElement("img")).width=r,u.height=n,u.addEventListener("load",function(){c(u)}),u.src=t.toDataURL("image/png")}else c(g)})})},e.decorators=[{type:t.Injectable}],e}(),o=function(){function e(e){this.imageExifService=e}return e.prototype.compressImage=function(i,r,n,o){var a=this;void 0===n&&(n=!1),void 0===o&&(o=!1);var s=new p.Subject;if(this.timeAtStart=(new Date).getTime(),"image/jpeg"!==(this.initialFile=i).type&&"image/png"!==i.type)return setTimeout(function(){s.error({compressedFile:i,reason:"File provided is neither of type jpg nor of type png.",error:"INVALID_EXTENSION"})},0),s.asObservable();if(i.size/1024/1024<r)return setTimeout(function(){s.next(i)},0),s.asObservable();var c=document.createElement("canvas"),u=c.getContext("2d"),g=new Image,f=this;return g.onload=function(){a.imageExifService.getOrientedImage(g).then(function(e){window.URL.revokeObjectURL(g.src),c.width=e.width,c.height=e.height,u.drawImage(e,0,0);var t=u.getImageData(0,0,e.width,e.height);"image/png"===i.type&&a.isImgUsingAlpha(t)&&!n&&s.error({compressedFile:i,reason:"File provided is a png image which uses the alpha channel. No compression possible.",error:"PNG_WITH_ALPHA"}),(u=c.getContext("2d",{alpha:!1})).drawImage(e,0,0),f.getCompressedFile(c,50,r,1).then(function(e){s.next(e),f.logExecutionTime(o)}).catch(function(e){s.error(e),f.logExecutionTime(o)})})},g.src=window.URL.createObjectURL(i),s.asObservable()},e.prototype.getCompressedFile=function(n,o,a,s){var c=this;return new Promise(function(i,r){n.toBlob(function(e){if(15<s+1)r({compressedFile:c.getResultFile(e),reason:"Could not find the correct compression quality in 15 steps.",error:"MAX_STEPS_EXCEEDED"});else{var t=c.getCalculatedQuality(e,o,a,s);c.checkCompressionStatus(n,e,o,a,s,t).then(function(e){i(e)}).catch(function(e){r(e)})}},"image/jpeg",o/100)})},e.prototype.getResultFile=function(e){return this.generateResultFile(e,this.initialFile.name,this.initialFile.type,(new Date).getTime())},e.prototype.generateResultFile=function(e,t,i,r){var n=new Blob([e],{type:i});return this.blobToFile(n,t,r)},e.prototype.blobToFile=function(e,t,i){var r=e;return r.name=t,r.lastModified=i,r},e.prototype.getCalculatedQuality=function(e,t,i,r){var n=e.size/1024/1024,o=i/n;5<o&&(o=5);var a=n/(this.initialFile.size/1024/1024);a<.05&&(a=.05);var s=0,c=10*Math.abs(a-1)/(1.7*r)/o;return c<1&&(c=1),100<(s=1<=o?t+10*(o-1)*c:t-10*(1-o)*c)&&(s=t+(100-t)/2),s<0&&(s=t-t/2),s},e.prototype.checkCompressionStatus=function(i,r,n,o,a,s){var c=this;return new Promise(function(e,t){100===n&&100<=s?t({compressedFile:c.initialFile,reason:"Unfortunately there was an error while compressing the file.",error:"FILE_BIGGER_THAN_INITIAL_FILE"}):n<1&&s<n?t({compressedFile:c.getResultFile(r),reason:"Could not compress image enough to fit the maximal file size limit.",error:"UNABLE_TO_COMPRESS_ENOUGH"}):n<s&&Math.round(n)==Math.round(s)?e(c.getResultFile(r)):5<a&&n<s&&s<n+2?e(c.getResultFile(r)):n<s&&Number.isInteger(n)&&Math.floor(s)==n?e(c.getResultFile(r)):(s<n&&Math.round(n)==Math.round(s)&&(s=Math.round(s)-1),e(c.getCompressedFile(i,s,o,a+1)))})},e.prototype.isImgUsingAlpha=function(e){for(var t=0;t<e.data.length;t+=4)if(255!==e.data[t+3])return!0;return!1},e.prototype.logExecutionTime=function(e){e&&console.info("Execution time: ",(new Date).getTime()-this.timeAtStart+"ms")},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:n,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return n})]}]}]},e}(),a=function(){function e(e,t){this.ng2PicaService=e,this.imageExifService=t}return e.prototype.resizeImage=function(o,a,s,c){var e=this;void 0===c&&(c=!1);var u=new p.Subject;if(this.timeAtStart=(new Date).getTime(),"image/jpeg"!==o.type&&"image/png"!==o.type)return setTimeout(function(){u.error({resizedFile:o,reason:"The provided File is neither of type jpg nor of type png.",error:"INVALID_EXTENSION"})},0),u.asObservable();var g=new Image,f=this;return g.onload=function(){e.imageExifService.getOrientedImage(g).then(function(e){window.URL.revokeObjectURL(g.src);var t=e.width,i=e.height,r=t,n=i;a<r&&(n*=(r=a)/t);s<(i=n)&&(r*=(n=s)/i);n===e.height&&r===e.width?(u.next(o),f.logExecutionTime(c)):f.ng2PicaService.resize([o],r,n).subscribe(function(e){u.next(e),f.logExecutionTime(c)},function(e){u.error({resizedFile:o,reason:e,error:"PICA_ERROR"}),f.logExecutionTime(c)})})},g.src=window.URL.createObjectURL(o),u.asObservable()},e.prototype.logExecutionTime=function(e){e&&console.info("Execution time: ",(new Date).getTime()-this.timeAtStart+"ms")},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:r.Ng2PicaService,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return r.Ng2PicaService})]}]},{type:n,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return n})]}]}]},e}(),s=function(){function e(e,t,i){this.imgMaxSizeService=e,this.imgMaxPXSizeService=t,this.imageExifService=i}return e.prototype.compress=function(e,t,i,r){var n=this;void 0===i&&(i=!1),void 0===r&&(r=!1);var o=new p.Subject;return e.forEach(function(e){n.compressImage(e,t,i,r).subscribe(function(e){o.next(e)},function(e){o.error(e)})}),o.asObservable()},e.prototype.resize=function(e,t,i,r){var n=this;void 0===r&&(r=!1);var o=new p.Subject;return e.forEach(function(e){n.resizeImage(e,t,i,r).subscribe(function(e){o.next(e)},function(e){o.error(e)})}),o.asObservable()},e.prototype.compressImage=function(e,t,i,r){return void 0===i&&(i=!1),void 0===r&&(r=!1),this.imgMaxSizeService.compressImage(e,t,i,r)},e.prototype.resizeImage=function(e,t,i,r){return void 0===r&&(r=!1),this.imgMaxPXSizeService.resizeImage(e,t,i,r)},e.prototype.getEXIFOrientedImage=function(e){return this.imageExifService.getOrientedImage(e)},e.decorators=[{type:t.Injectable}],e.ctorParameters=function(){return[{type:o,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return o})]}]},{type:a,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return a})]}]},{type:n,decorators:[{type:t.Inject,args:[t.forwardRef(function(){return n})]}]}]},e}(),c=function(){function e(){}return e.decorators=[{type:t.NgModule,args:[{imports:[r.Ng2PicaModule],providers:[{provide:a,useClass:a},{provide:o,useClass:o},{provide:n,useClass:n},{provide:s,useClass:s}]}]}],e}();e.Ng2ImgMaxService=s,e.Ng2ImgMaxModule=c,e.ImgMaxSizeService=o,e.ImgMaxPXSizeService=a,e.ImgExifService=n,Object.defineProperty(e,"__esModule",{value:!0})});